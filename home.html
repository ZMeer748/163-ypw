<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ypw - 主页</title>
    <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.15.0/umd/popper.min.js"></script>
    <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcss.com/font-awesome/5.10.0-11/js/all.min.js"></script>
    <script src="https://cdn.bootcss.com/toastr.js/latest/toastr.min.js"></script>
    <script src="js/ypw.js"></script>
    <link rel="stylesheet" href="css/home-style.css">
    <script>
        function addTodayGame(game) {
            var today_game_txt =
                "    <!-- today-game -->" +
                "    <div class=\"card bg-dark text-white today-game-container border-0\"  id=\"today_game_" + game
                .id + "\">" +
                "        <img class=\"card-img today-game-bg-img\" src=\"res/games/" + game.id +
                "/main_pic.jpg\" alt=\"Card image\">" +
                "        <div class=\"card-img-overlay m-0 p-0 today-game-overlay\">" +
                "            <h1 class=\"card-title today-game-text-main\">今日游戏" +
                "                <div class=\"float-right font-weight-light today-game-text-past\">" +
                "                    <i class=\"far fa-calendar-alt fa-sm fa-fw\"></i> 往期" +
                "                </div>" +
                "            </h1>" +
                "            <div class=\"media bg-dark today-game-footer\">" +
                "                <img class=\"align-self-centers today-game-footer-icon\" src=\"res/games/" + game.id +
                "/icon.png\"" +
                "                    alt=\"Generic placeholder image\">" +
                "                <div class=\"media-body today-game-footer-content\">" +
                "                    <p class=\"mt-0 mb-0 today-game-footer-content-tittle\">" + game.name + "</p>" +
                "                    <p class=\"today-game-footer-content-description\">" + game.main_description +
                "</p>" +
                "                </div>" +
                "                <div class=\"today-game-footer-mark\"><i class=\"fas fa-medal fa-sm fa-fw mt-1\"></i> " +
                game.mark + "</div>" +
                "            </div>" +
                "        </div>" +
                "    </div>";
            $('.home-main-header').after(today_game_txt);
        }

        function addGameCard(game, i) {
            var game_card_txt =
                "    <!-- game-card-example -->" +
                "    <div class=\"card home-card-container border-0\" id=\"home_game_card_" + game.id + "\">" +
                "        <div class=\"card-body pl-0 pr-0 pb-0 home-card-header\">" +
                "            <div class=\"media\">" +
                "                <img class=\"align-self-centers mr-2 home-game-card-header-icon\"" +
                "                    src=\"res/games/" + game.id +
                "/icon.png\">" +
                "                <div class=\"media-body home-game-card-header-tittle\">" +
                "                    <p class=\"mt-0 mb-0\">" + game.name + "</p>" +
                "                </div>" +
                "                <div class=\"home-card-container-header-arrow\" id=\"game_arrow_" + game.id + "\">" +
                "                    <i class=\"fa fa-angle-down fa-lg \" aria-hidden=\"true\" style=\"color: #b2b2b2\"></i>" +
                "                </div>" +
                "            </div>" +
                "        </div>" +
                "        <p class=\"home-card-description\">" + game.main_description + "</p>" +
                "        <div class=\"home-game-card-img-container\">" +
                "            <img class=\"card-img-top home-game-card-img\" src=\"res/games/" + game.id +
                "/main_pic.jpg\"" +
                "                alt=\"Card image cap\"></div>" +
                "        <div class=\"card-body p-0 home-game-card-footer\">" +
                "            <div class=\"home-game-card-footer-mark\"><i class=\"fas fa-gamepad\"></i> 游戏评分：" +
                game.mark + "</div>" +
                "            <div href=\"#\" class=\"home-game-card-footer-download\">下载</div>" +
                "        </div>" +
                "    </div>" +
                "    <hr class=\"mb-0\" id=\"game-card-hr-" + i + "\">";
            $('.footer-block').before(game_card_txt);
        }

        function addPostCard(post, i, before_hr) {
            var post_card_txt =
                "    <!-- post-card-example -->" +
                "    <div class=\"card home-card-container border-0\" id=\"home_post_card_" + post.id + "\">" +
                "        <div class=\"card-body pl-0 pr-0 pb-0 home-card-header\">" +
                "            <div class=\"media\">" +
                "                <img class=\"align-self-centers mr-2 home-post-card-header-user-icon\"" +
                "                    src=\"res/posts/" + post.id +
                "/user_icon.jpg\" alt=\"Generic placeholder image\">" +
                "                <div class=\"media-body home-post-card-header-user-name\">" +
                "                    <p class=\"mt-0 mb-0\">" + post.user_name + "</p>" +
                "                </div>" +
                "                <div class=\"home-card-container-header-arrow\" id=\"post_arrow_" + post.id + "\">" +
                "                    <i class=\"fa fa-angle-down fa-lg \" aria-hidden=\"true\" style=\"color: #b2b2b2\"></i>" +
                "                </div>" +
                "            </div>" +
                "        </div>" +
                "        <p class=\"home-post-card-tittle\">" + post.tittle + "</p>" +
                "        <p class=\"home-card-description\">" + post.main_description + "</p>" +
                "        <div class=\"home-post-card-img-container\">";
            if (post.pic_num >= 3) {
                post_card_txt +=
                    "            <div class=\"home-post-card-img-container-left\">" +
                    "                <img class=\"card-img-top home-post-card-img\" src=\"res/posts/" + post.id +
                    "/1.jpg\" alt=\"Card image cap\">" +
                    "            </div>" +
                    "            <div class=\"home-post-card-img-container-right-top\">" +
                    "                <img class=\"card-img-top home-post-card-img\" src=\"res/posts/" + post.id +
                    "/2.jpg\" alt=\"Card image cap\">" +
                    "            </div>" +
                    "            <div class=\"home-post-card-img-container-right-bottom\">" +
                    "                <img class=\"card-img-top home-post-card-img\" src=\"res/posts/" + post.id +
                    "/3.jpg\" alt=\"Card image cap\">" +
                    "            </div>";
            } else {
                post_card_txt +=
                    "            <img class=\"card-img-top home-post-card-img\" src=\"res/posts/" + post.id +
                    "/1.jpg\" alt=\"Card image cap\">";
            }

            post_card_txt +=
                "        </div>" +
                "        <div class=\"card-body p-0 home-post-card-footer\">" +
                "            <div href=\"#\" class=\"home-post-card-footer-sort\"><b>#</b> " + post.sort + "</div>" +
                "            <div href=\"#\" class=\"home-post-card-footer-coin\"><i class=\"fas fa-coins\"></i> " +
                post.coins_count + "</div>" +
                "            <div href=\"#\" class=\"home-post-card-footer-comment\"><i class=\"far fa-comment-alt\"></i> " +
                post.comment_count + "</div>" +
                "        </div>" +
                "    </div>" +
                "    <hr class=\"mb-0\" id=\"post-card-hr-" + i++ + "\">";
            $(before_hr).after(post_card_txt);
        }

        $(function () {

            var game_json;
            var post_json;

            function Game_JSON_Process(callback) {
                $.getJSON('res/games/games.json', function (data) {
                    callback(data);
                });
            };

            function Post_JSON_Process(callback) {
                $.getJSON('res/posts/posts.json', function (data) {
                    callback(data);
                });
            };

            Game_JSON_Process(function (data) {
                game_json = data;
                generate_today_game();
                generate_game_card();
            });

            Post_JSON_Process(function (data) {
                post_json = data;
                generate_post_card();
            });


            function generate_today_game() {
                var index;
                for (;;) {
                    index = Math.floor((Math.random() * game_json.games.length));
                    var temp_id = game_json.games[index].id;
                    if (temp_id != 25260 && temp_id != 18283 && temp_id != 31903 && temp_id != 31510 &&
                        temp_id != 32611 && temp_id != 31996) {
                        break;
                    }
                }
                addTodayGame(game_json.games[index]);
            };

            function generate_game_card() {
                var i = 0;
                var k = 0;
                var gameArr = new Array();
                for (var k = 0; k <= 16; k++) {
                    var index = Math.floor((Math.random() * game_json.games.length));
                    if ($.inArray(index, gameArr) != -1) {
                        k = k - 1;
                        continue;
                    }
                    gameArr[gameArr.length] = index;
                    addGameCard(game_json.games[index], i++);
                };
            };

            function generate_post_card() {
                var i = 0;
                var j = 1;
                var k = 0;
                var postArr = new Array();
                for (var k = 0; k <= 9; k++) {
                    var index = Math.floor((Math.random() * post_json.posts.length));
                    if ($.inArray(index, postArr) != -1) {
                        k = k - 1;
                        continue;
                    }
                    if (i % 3 == 0) {
                        j += 2;
                    }
                    postArr[postArr.length] = index;
                    addPostCard(post_json.posts[index], i++, '#game-card-hr-' + j);
                };
            };

            function autoPopulate(field, id) {
                console.log(game_json.posts);
            };
        });
    </script>
</head>

<body>
    <!-- header -->
    <nav class="navbar navbar-light fixed-top home-main-header">
        <div></div>
        <a class="navbar-brand m-0 p-0" href="#">
            <img src="res/main_page_pic/logo.png" alt="Responsive image" class="home-main-header-logo">
        </a>
        <div></div>
    </nav>

    <!-- Modal -->
    <div class="modal fade" id="cardPopModal" tabindex="-1" role="dialog" aria-labelledby="cardPopModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content float-right">
                <div class="modal-body p-0">
                    <button id="modal_not_interested" class="btn btn-light mb-0 w-100 h-50">不感兴趣</button>
                    <hr class="mb-0 mt-0">
                    <button id="modal_report" class="btn btn-light mb-0 w-100 h-50">举报</button>
                </div>
            </div>
        </div>
    </div>

    <!-- footer -->
    <div class="footer-block"></div>
    <nav class="navbar fixed-bottom main-footer" aria-label="Basic example">
        <a href="home.html">
            <img class="main-footer-btn" src="res/main_page_pic/footer_btn_home_selected.png" alt=""></a>
        <a href="javascript:void(0)">
            <img class="main-footer-btn" id="main-footer-btn-discover" src="res/main_page_pic/footer_btn_discover.png"
                alt=""></a>
        <a href="game.html">
            <img class="main-footer-btn" src="res/main_page_pic/footer_btn_game.png" alt=""></a>
        <a href="search.html">
            <img class="main-footer-btn" src="res/main_page_pic/footer_btn_search.png" alt=""></a>
        <a href="user.html">
            <img class="main-footer-btn" src="res/main_page_pic/footer_btn_user.png" alt=""></a>
    </nav>

    <div id="log" class="fixed-top" style="text-align: center;"></div>
    <div id="log_2" class="fixed-bottom" style="text-align: center;"></div>
    <script>
        var temp_arrow_id;

        $(window).resize(function () {
            home_Elements_resize();
        });

        function home_Elements_resize() {
            $('.today-game-container').height($('.today-game-container').width() * 1.08);
            $('.home-post-card-img-container').height($('.home-post-card-img-container').width() * 0.56);
            $('.home-game-card-img-container').height($('.home-game-card-img-container').width() * 0.61);
        }

        function log(txt) {
            $('#log').html('location : <b>' + txt + '</b> px')
        }

        function log_2(txt) {
            $('#log_2').html('location : <b>' + txt + '</b> px')
        }

        function card_fadeout(arrow_id) {
            $(arrow_id).parent().parent().parent().fadeOut();
            $(arrow_id).parent().parent().parent().next('hr').fadeOut();
        }

        $(function () {
            home_Elements_resize();
        });

        $(document).on('click', '#modal_not_interested', function () {
            $('#cardPopModal').modal('toggle');
            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": false,
                "progressBar": false,
                "positionClass": "toast-bottom-center",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "1000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            }
            toastr.info("将减少此类推荐");
            card_fadeout(temp_arrow_id);
        });

        $(document).on('click', '#modal_report', function () {
            $('#cardPopModal').modal('toggle');
            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": false,
                "progressBar": false,
                "positionClass": "toast-bottom-center",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "1000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            }
            toastr.info("投诉成功");
            card_fadeout(temp_arrow_id);
        });

        $(document).on('click', '.home-card-container-header-arrow', function () {
            var eTop = $(this).offset().top;
            console.log(eTop - $(window).scrollTop());
            var modalContentTop = eTop - $(window).scrollTop() + $('.home-card-header')
                .height();
            console.log(modalContentTop + $('.modal-content').height());
            var modalContentBottom = modalContentTop + $('.modal-content').height()
            if (modalContentBottom > $(window).height()) {
                $('#cardPopModal .modal-content').css('top', $(window).height() - $(
                    '.modal-content').height() - 16);
            } else {
                $('#cardPopModal .modal-content').css('top', modalContentTop);
            }
            $('#cardPopModal').modal('toggle');
            temp_arrow_id = '#' + this.id;
        });
    </script>
</body>

</html>